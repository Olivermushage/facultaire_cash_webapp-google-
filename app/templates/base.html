<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}ULPGL Application{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <a href="#main-content" class="skip-link">Passer au contenu</a>

    <!-- Topbar -->
    <div class="topbar">
        {% if current_user.is_authenticated %}
            <span class="user-info">üë§ Connect√© : {{ current_user.username }}</span>
            <a href="{{ url_for('auth.logout') }}" class="logout-button" role="button">D√©connexion</a>
        {% else %}
            <a href="{{ url_for('auth.login') }}" class="logout-button" role="button">Connexion</a>
        {% endif %}
         <!-- Bouton hamburger responsive (affich√© en mobile) -->
        <button id="menu-toggle" aria-label="Toggle menu" aria-expanded="false" aria-controls="sidebar" class="hamburger-btn">‚ò∞</button>
    </div>

    <div class="container">
        <!-- Navigation principale -->
        <nav aria-label="Navigation principale" role="navigation" class="sidebar">
            <a href="{{ url_for('main.index') }}" aria-label="Accueil ULPGL">
                <img src="{{ url_for('static', filename='ulpgl-logo.png') }}" alt="Logo ULPGL" class="logo">
            </a>

            {% set current_endpoint = request.endpoint %}

            <!-- Menu Section Macro -->
            {% macro menu_section(title, items, menu_id) %}
            <div class="menu-section">
                <h3 class="menu-header" tabindex="0" role="button" aria-expanded="false" aria-controls="{{ menu_id }}">{{ title }}</h3>
                <div class="menu-items" id="{{ menu_id }}" hidden>
                    {% for item in items %}
                        {% if item.url %}
                            <a href="{{ item.url }}" class="menu-item {% if item.endpoint == current_endpoint %}active{% endif %}">{{ item.label }}</a>
                        {% else %}
                            <span class="menu-item disabled">{{ item.label }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endmacro %}

            <!-- Menus principaux -->
            {{ menu_section('G√©n√©ral', [
                {'label':'Accueil', 'url': url_for('main.index'), 'endpoint':'main.index'},
                {'label':'Historique', 'url': url_for('main.historique'), 'endpoint':'main.historique'},
            ], 'general-menu') }}

            {{ menu_section('Classes & √âtudiants', [
                {'label':'Liste des classes', 'url': url_for('classes.liste_classes'), 'endpoint':'classes.liste_classes'},
                {'label':'Ajouter une classe', 'url': url_for('classes.creer_classe'), 'endpoint':'classes.creer_classe'}
            ], 'classes-menu') }}

            {{ menu_section('Paiements & Cat√©gories', [
                {'label':'Gestion cat√©gories de paiement', 'url': url_for('categories.gerer_categories'), 'endpoint':'categories.gerer_categories'},
                {'label':'Suivi des paiements par classe', 'url': url_for('classes.choisir_classe_paiement'), 'endpoint':'classes.choisir_classe_paiement'}
            ], 'paiements-menu') }}

            {{ menu_section('Recettes', [
                {'label':'Ajouter une recette', 'url': url_for('recettes.ajouter_recette'), 'endpoint':'recettes.ajouter_recette'},
                {'label':'Voir toutes les recettes', 'url': url_for('recettes.index_recettes'), 'endpoint':'recettes.index_recettes'}
            ], 'recettes-menu') }}

            {{ menu_section('D√©penses', [
                {'label':'Vue globale des d√©penses', 'url': url_for('depenses.depenses_index'), 'endpoint':'depenses.depenses_index'},
                {'label':'Ajouter une d√©pense (autres)', 'url': url_for('depenses.ajouter_depense_autres'), 'endpoint':'depenses.ajouter_depense_autres'}
            ], 'depenses-menu') }}

            {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <a href="{{ url_for('auth.create_user_route') }}" class="btn-primary-menu" role="button">Cr√©er un utilisateur</a>
            {% endif %}
        </nav>

        <!-- Contenu principal -->
        <main id="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-container">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category }}" role="alert">
                                {{ message }}
                                <button class="flash-close-btn" aria-label="Fermer le message" onclick="this.parentElement.style.display='none';">√ó</button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <footer>¬© 2025 ULPGL - Tous droits r√©serv√©s</footer>

    <script>
        // Menu collapsible
        document.querySelectorAll('.menu-header').forEach(header => {
            const menuItems = header.nextElementSibling;
            header.addEventListener('click', () => {
                const expanded = header.getAttribute('aria-expanded') === 'true';
                header.setAttribute('aria-expanded', !expanded);
                if(menuItems) menuItems.toggleAttribute('hidden');
            });
            header.addEventListener('keydown', e => {
                if(e.key==='Enter'||e.key===' ') { e.preventDefault(); header.click(); }
            });
        });

        // Flash message auto fade
        document.querySelectorAll('.flash-message').forEach(msg => {
            setTimeout(() => { 
                msg.style.opacity = '0'; 
                setTimeout(()=>{ msg.style.display='none'; }, 500); 
            }, 5000);
        });
    </script>
<script>
  const toggleBtn = document.getElementById('menu-toggle');
  const sidebar = document.querySelector('nav.sidebar');
  toggleBtn.addEventListener('click', () => {
    const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
    toggleBtn.setAttribute('aria-expanded', !expanded);
    sidebar.classList.toggle('open');
  });
</script>
</body>
</html>
