{% extends "base.html" %}

{% block title %}Classe - {{ nom_classe }}{% endblock %}

{% block content %}
<h2>Classe : {{ nom_classe }}</h2>

{# Messages flash #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
          <button class="flash-close-btn" onclick="this.parentElement.style.display='none';">√ó</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Actions principales -->
<!-- <div class="actions-section">
    <a href="{{ url_for('classes.ajouter_depense_travail', nom_classe=nom_classe) }}" class="btn-success">
        ‚ûï D√©pense travaux √©tudiants
    </a>
    <a href="{{ url_for('depenses.choisir_classe_examen', nom_classe=nom_classe) }}" class="btn-secondary">
        üìÑ D√©penses examens
    </a>
</div> -->

<!-- Barre de recherche -->
<form method="get" class="form-inline search-form">
    <input type="text" name="recherche" value="{{ request.args.get('recherche', '') }}"
           placeholder="üîç Rechercher un √©tudiant..." class="input-default">
    <button type="submit" class="btn-primary">Filtrer</button>
    {% if request.args.get('recherche') %}
        <a href="{{ url_for('classes.detail_classe', nom_classe=nom_classe) }}" class="link-muted">R√©initialiser</a>
    {% endif %}
</form>

<!-- PDF -->
<section class="pdf-section">
    <h3>Impressions PDF</h3>
    {% for cat in categories_paiement %}
        <a href="{{ url_for('classes.generer_pdf_categorie', nom_classe=nom_classe, categorie=cat) }}"
           class="btn-secondary" target="_blank">üìÑ {{ cat }}</a>
    {% endfor %}
    <a href="{{ url_for('classes.generer_pdf_categorie', nom_classe=nom_classe, categorie='Toutes') }}"
       class="btn-secondary" target="_blank" download>
        üñ®Ô∏è Tout t√©l√©charger
    </a>
</section>


</section>

<!-- Tableau √©tudiants -->
<section class="table-section">
    <h3>√âtudiants et paiements</h3>
    <a href="{{ url_for('classes.ajouter_etudiant', nom_classe=nom_classe) }}" class="btn-success">‚ûï Ajouter √©tudiants</a>

    <table class="table-default">
        <thead>
            <tr>
                <th>#</th>
                <th>Nom</th>
                <th>Commentaire</th>
                <th>Paiements</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if etudiants %}
              {% for etu in etudiants %}
                <tr>
                    <td>{{ loop.index0 + 1 + ((page - 1) * per_page) }}</td>
                    <td>{{ etu.Etudiant }}</td>
                    <td>{{ etu.Commentaire|default('-') }}</td>
                    <td>
                        {% if paiements.get(etu.Etudiant) %}
                            <ul>
                                {% for p in paiements[etu.Etudiant] %}
                                    <li>
                                        {{ p.CategoriePaiement }} : {{ "%.2f"|format(p.Montant) }} USD ({{ p.DatePaiement }})
                                        {% if p.ID is defined %}
                                        <a href="{{ url_for('classes.modifier_paiement', nom_classe=nom_classe, paiement_id=p.ID) }}">‚úèÔ∏è</a>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            Aucun
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('classes.modifier_etudiant', nom_classe=nom_classe, etudiant=etu.Etudiant) }}">Modifier</a> |
                        <a href="{{ url_for('classes.ajouter_paiement', nom_classe=nom_classe, etudiant=etu.Etudiant) }}">+ Paiement</a>
                    </td>
                </tr>
              {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5">Aucun √©tudiant enregistr√©</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</section>

<!-- Pagination -->
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('classes.detail_classe', nom_classe=nom_classe, page=page-1, recherche=request.args.get('recherche','')) }}">&laquo; Pr√©c√©dent</a>
    {% endif %}
    <span>Page {{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
        <a href="{{ url_for('classes.detail_classe', nom_classe=nom_classe, page=page+1, recherche=request.args.get('recherche','')) }}">Suivant &raquo;</a>
    {% endif %}
</div>

<!-- Cours -->
<section class="cours-section">
    <h3>Cours</h3>
    <ul>
        {% if cours_classe %}
            {% for c in cours_classe %}
                <li>{{ c }}</li>
            {% endfor %}
        {% else %}
            <li>Aucun cours d√©fini</li>
        {% endif %}
    </ul>
    <a href="{{ url_for('classes.ajouter_cours', nom_classe=nom_classe) }}" class="btn-secondary">
        ‚ûï Ajouter cours
    </a>
</section>

<script>
function openPrintPdf(url) {
    const printWindow = window.open(url, '_blank');
    const timer = setInterval(function() {
        if (printWindow.document.readyState === 'complete') {
            printWindow.focus();
            printWindow.print();
            clearInterval(timer);
        }
    }, 500);
}
</script>
{% endblock %}
