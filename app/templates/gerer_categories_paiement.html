{% extends "base.html" %}

{% block title %}Gestion des cat√©gories{% endblock %}

{% block content %}
<h1>üìÇ Gestion des cat√©gories de paiement et d√©pense</h1>

<!-- Messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Ajouter une cat√©gorie -->
<section class="form-section">
  <h2>‚ûï Ajouter une nouvelle cat√©gorie</h2>
  <form method="post" class="form-default">
    <input type="hidden" name="action" value="ajouter">

    <label for="type_categorie_ajout">Type <span class="text-danger">*</span></label>
    <select id="type_categorie_ajout" name="type_categorie" required class="select-default">
      <option value="" disabled selected>-- Choisissez un type --</option>
      <option value="paiement" {% if request.form.get('type_categorie')=='paiement' %}selected{% endif %}>Cat√©gorie de paiement</option>
      <option value="depense" {% if request.form.get('type_categorie')=='depense' %}selected{% endif %}>Cat√©gorie de d√©pense</option>
    </select>

    <label for="nouvelle_categorie">Nom <span class="text-danger">*</span></label>
    <input type="text" id="nouvelle_categorie" name="nouvelle_categorie"
           value="{{ request.form.get('nouvelle_categorie','') }}" required class="input-default">

    <button type="submit" class="btn-primary" aria-label="Ajouter cat√©gorie">‚úÖ Ajouter</button>
  </form>
</section>

<!-- Modifier une cat√©gorie -->
<section class="form-section">
  <h2>‚úèÔ∏è Modifier une cat√©gorie existante</h2>
  <form method="post" class="form-default">
    <input type="hidden" name="action" value="modifier">

    <label for="type_categorie_modif">Type <span class="text-danger">*</span></label>
    <select id="type_categorie_modif" name="type_categorie" required class="select-default" onchange="updateSelectOptions('ancienne_categorie', this.value, '{{ request.form.get('ancienne_categorie','') }}')">
      <option value="" disabled selected>-- Choisissez un type --</option>
      <option value="paiement" {% if request.form.get('type_categorie')=='paiement' %}selected{% endif %}>Cat√©gorie de paiement</option>
      <option value="depense" {% if request.form.get('type_categorie')=='depense' %}selected{% endif %}>Cat√©gorie de d√©pense</option>
    </select>

    <label for="ancienne_categorie">Cat√©gorie √† modifier <span class="text-danger">*</span></label>
    <select id="ancienne_categorie" name="ancienne_categorie" required class="select-default">
      <option value="" disabled selected>-- S√©lectionnez une cat√©gorie --</option>
    </select>
    {% if not categories_paiement and not categories_depense %}
      <div class="text-muted">Aucune cat√©gorie disponible pour modification.</div>
    {% endif %}

    <label for="nouvelle_categorie_modif">Nouveau nom <span class="text-danger">*</span></label>
    <input type="text" id="nouvelle_categorie_modif" name="nouvelle_categorie_modif"
           value="{{ request.form.get('nouvelle_categorie_modif','') }}" required class="input-default">

    <button type="submit" class="btn-success" aria-label="Modifier cat√©gorie">üíæ Enregistrer</button>
  </form>
</section>

<!-- Supprimer une cat√©gorie -->
<section class="form-section">
  <h2>üóëÔ∏è Supprimer une cat√©gorie</h2>
  <form method="post" class="form-default">
    <input type="hidden" name="action" value="supprimer">

    <label for="type_categorie_suppr">Type <span class="text-danger">*</span></label>
    <select id="type_categorie_suppr" name="type_categorie" required class="select-default" onchange="updateSelectOptions('categorie_suppr', this.value, '{{ request.form.get('categorie_suppr','') }}')">
      <option value="" disabled selected>-- Choisissez un type --</option>
      <option value="paiement" {% if request.form.get('type_categorie')=='paiement' %}selected{% endif %}>Cat√©gorie de paiement</option>
      <option value="depense" {% if request.form.get('type_categorie')=='depense' %}selected{% endif %}>Cat√©gorie de d√©pense</option>
    </select>

    <label for="categorie_suppr">Cat√©gorie <span class="text-danger">*</span></label>
    <select id="categorie_suppr" name="categorie_suppr" required class="select-default">
      <option value="" disabled selected>-- S√©lectionnez une cat√©gorie --</option>
    </select>
    {% if not categories_paiement and not categories_depense %}
      <div class="text-muted">Aucune cat√©gorie disponible pour suppression.</div>
    {% endif %}

    <button type="submit" class="btn-danger" aria-label="Supprimer cat√©gorie"
            onclick="return confirm('Voulez-vous vraiment supprimer cette cat√©gorie ? Cette action est irr√©versible.');">
      ‚ùå Supprimer
    </button>
  </form>
</section>

<p class="mt-40">
  <a href="{{ url_for('main.index') }}" class="link-default">‚¨Ö Retour √† l'accueil</a>
</p>

<script>
const categoriesPaiement = {{ categories_paiement|tojson }};
const categoriesDepense = {{ categories_depense|tojson }};

// Fonction universelle pour remplir les selects avec option pr√©-s√©lectionn√©e
function updateSelectOptions(selectId, type, selectedValue=null) {
  const selectElement = document.getElementById(selectId);
  selectElement.innerHTML = "";
  
  const defaultOption = document.createElement("option");
  defaultOption.value = "";
  defaultOption.textContent = "-- S√©lectionnez une cat√©gorie --";
  defaultOption.disabled = true;
  defaultOption.selected = true;
  selectElement.appendChild(defaultOption);

  let data = [];
  if (type === "paiement") data = categoriesPaiement;
  else if (type === "depense") data = categoriesDepense;

  data.forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    if (selectedValue && selectedValue === cat) option.selected = true;
    selectElement.appendChild(option);
  });
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
  // Remplir selects si un type est d√©j√† choisi
  const modifType = document.getElementById("type_categorie_modif").value;
  if(modifType) updateSelectOptions('ancienne_categorie', modifType, '{{ request.form.get("ancienne_categorie","") }}');

  const supprType = document.getElementById("type_categorie_suppr").value;
  if(supprType) updateSelectOptions('categorie_suppr', supprType, '{{ request.form.get("categorie_suppr","") }}');
});
</script>
{% endblock %}
