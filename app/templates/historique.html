{% extends "base.html" %}

{% block title %}Historique des opérations{% endblock %}

{% block content %}
<h1>Historique des opérations</h1>

<!-- Formulaire de recherche -->
<form method="get" class="form-inline">
    <input type="text" name="recherche" value="{{ request.args.get('recherche', '') }}"
           placeholder="Rechercher..." class="input-search">
    <button type="submit" class="btn-primary">Filtrer</button>
    {% if request.args.get('recherche') %}
        <a href="{{ url_for('historique') }}" class="link-reset">Réinitialiser</a>
    {% endif %}
</form>

<!-- Section opérations en caisse -->
<h2>Opérations en caisse</h2>
<div class="table-scroll">
    <table class="table-default">
        <thead>
            <tr>
                <th>Date & heure</th>
                <th>Utilisateur</th>
                <th>Nom</th>
                <th>Type</th>
                <th>Montant (USD)</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for op in operations %}
            <tr>
                <td>{{ op.date_heure or op.Date or '-' }}</td>
                <td>{{ op.utilisateur or 'Inconnu' }}</td>
                <td>{{ op.Nom or '-' }}</td>
                <td>{{ op.Type or '-' }}</td>
                <td>{{ "%.2f"|format(op.Montant) if op.Montant else "0.00" }} USD</td>
                <td>{{ op.Description or '-' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center">Aucune opération enregistrée.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination">
    {% if page > 1 %}
        <a href="{{ url_for('historique', page=page-1, recherche=request.args.get('recherche','')) }}">&laquo; Précédent</a>
    {% else %}
        <span class="disabled">&laquo; Précédent</span>
    {% endif %}
    <span>Page {{ page }} sur {{ total_pages }}</span>
    {% if page < total_pages %}
        <a href="{{ url_for('historique', page=page+1, recherche=request.args.get('recherche','')) }}">Suivant &raquo;</a>
    {% else %}
        <span class="disabled">Suivant &raquo;</span>
    {% endif %}
</div>

<!-- Section dépenses classiques -->
<h2>Dépenses classiques</h2>
<div class="table-scroll">
    <table class="table-default">
        <thead>
            <tr>
                <th>Nom Classe</th>
                <th>Date</th>
                <th>Catégorie</th>
                <th>Description</th>
                <th>Montant (USD)</th>
            </tr>
        </thead>
        <tbody>
            {% for dep in depenses_classiques %}
            <tr>
                <td>{{ dep.NomClasse or '-' }}</td>
                <td>{{ dep.DateExamen or dep.DateDepense or '-' }}</td>
                <td>{{ dep.CategorieDepense or '-' }}</td>
                <td>{{ dep.Description or dep.Commentaire or '-' }}</td>
                <td>{{ "%.2f"|format(dep.Montant) if dep.Montant else "0.00" }} USD</td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center">Aucune dépense classique enregistrée.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Section dépenses travaux -->
<h2>Dépenses liées aux travaux</h2>
<div class="table-scroll">
    <table class="table-default">
        <thead>
            <tr>
                <th>Nom Classe</th>
                <th>Étudiant</th>
                <th>Catégorie Travail</th>
                <th>Type Dépense</th>
                <th>Commentaire</th>
                <th>Date</th>
                <th>Montant (USD)</th>
            </tr>
        </thead>
        <tbody>
            {% for dep in depenses_travaux %}
            <tr>
                <td>{{ dep.NomClasse or '-' }}</td>
                <td>{{ dep.Etudiant or '-' }}</td>
                <td>{{ dep.CategorieDepense or dep.CategorieTravail or '-' }}</td>
                <td>{{ dep.TypeDepense or '-' }}</td>
                <td>{{ dep.Commentaire or '-' }}</td>
                <td>{{ dep.DateDepense or '-' }}</td>
                <td>{{ "%.2f"|format(dep.Montant) if dep.Montant else "0.00" }} USD</td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center">Aucune dépense liée aux travaux enregistrée.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Section recettes -->
<h2>Recettes</h2>
<div class="table-scroll">
    <table class="table-default">
        <thead>
            <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Type</th>
                <th>Description</th>
                <th>Montant (USD)</th>
            </tr>
        </thead>
        <tbody>
            {% for rec in recettes %}
            <tr>
                <td>{{ rec.Date or '-' }}</td>
                <td>{{ rec.Source or '-' }}</td>
                <td>{{ rec.Type or '-' }}</td>
                <td>{{ rec.Description or '-' }}</td>
                <td>{{ "%.2f"|format(rec.Montant) if rec.Montant else "0.00" }} USD</td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center">Aucune recette enregistrée.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a href="{{ url_for('main.index') }}" class="btn-link">Retour à l'accueil</a>
{% endblock %}
