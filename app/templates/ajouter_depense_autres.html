{% extends "base.html" %}

{% block title %}Ajouter une autre dépense{% endblock %}

{% block content %}
<h2>Ajouter une autre dépense</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message
            {% if category == 'success' %}flash-success{% endif %}
            {% if category == 'error' %}flash-error{% endif %}
            {% if category == 'warning' %}flash-warning{% endif %}
            {% if category == 'info' %}flash-info{% endif %}">
          {{ message }}
          <button class="flash-close-btn" aria-label="Fermer le message" onclick="this.parentElement.style.display='none';">×</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" action="{{ url_for('depenses.ajouter_depense_autres') }}" class="form-default">

    <label for="type_depense" class="label-default">Type de dépense <span class="text-danger">*</span></label>
    <select id="type_depense" name="type_depense" required class="input-default" onchange="toggleFields()">
        <option value="manuelle" {% if request.form.get('type_depense') == 'manuelle' %}selected{% endif %}>Manuelle</option>
        <option value="standard" {% if request.form.get('type_depense') == 'standard' %}selected{% endif %}>Standard</option>
    </select>

    <div id="standard_fields" style="display:none; margin-top:10px;">
        <label for="sous_type_standard" class="label-default">Sous-type <span class="text-danger">*</span></label>
        <select id="sous_type_standard" name="sous_type_standard" class="input-default" onchange="toggleStandardSubFields()">
            <option value="autre" {% if request.form.get('sous_type_standard') == 'autre' %}selected{% endif %}>Autre</option>
            <option value="travaux" {% if request.form.get('sous_type_standard') == 'travaux' %}selected{% endif %}>Travaux</option>
            <option value="examen" {% if request.form.get('sous_type_standard') == 'examen' %}selected{% endif %}>Examen</option>
        </select>

        <div id="autre_fields" style="display:none;">
            <label for="categorie" class="label-default">Catégorie</label>
            <select id="categorie" name="categorie" class="input-default">
                <option value="">-- Sélectionner une catégorie --</option>
                {% for cat in categories %}<option value="{{ cat }}" {% if request.form.get('categorie') == cat %}selected{% endif %}>{{ cat }}</option>{% endfor %}
            </select>
        </div>

        <div id="travaux_fields" style="display:none;">
            <label for="nom_classe_travaux" class="label-default">Classe</label>
            <select id="nom_classe_travaux" name="nom_classe_travaux" class="input-default" onchange="filterEtudiants()">
                <option value="">-- Sélectionner une classe --</option>
                {% for c in classes %}<option value="{{ c }}" {% if request.form.get('nom_classe_travaux') == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
            </select>

            <label for="etudiant_travaux" class="label-default">Étudiant</label>
            <select id="etudiant_travaux" name="etudiant_travaux" class="input-default">
                <option value="">-- Sélectionner un étudiant --</option>
                {% for e in etudiants %}<option value="{{ e }}" {% if request.form.get('etudiant_travaux') == e %}selected{% endif %}>{{ e }}</option>{% endfor %}
            </select>
        </div>

        <div id="examen_fields" style="display:none;">
            <label for="nom_classe_examen" class="label-default">Classe</label>
            <select id="nom_classe_examen" name="nom_classe_examen" class="input-default" onchange="filterCours()">
                <option value="">-- Sélectionner une classe --</option>
                {% for c in classes %}<option value="{{ c }}" {% if request.form.get('nom_classe_examen') == c %}selected{% endif %}>{{ c }}</option>{% endfor %}
            </select>

            <label for="nom_cours_examen" class="label-default">Cours</label>
            <select id="nom_cours_examen" name="nom_cours_examen" class="input-default">
                <option value="">-- Sélectionner un cours --</option>
                {% for cours in cours %}<option value="{{ cours }}" {% if request.form.get('nom_cours_examen') == cours %}selected{% endif %}>{{ cours }}</option>{% endfor %}
            </select>
        </div>

        <label for="commentaire_standard" class="label-default">Commentaire</label>
        <input type="text" id="commentaire_standard" name="commentaire_standard" placeholder="Optionnel" value="{{ request.form.get('commentaire_standard', '') }}" class="input-default">
    </div>

    <label for="description" class="label-default">Description</label>
    <input type="text" id="description" name="description" placeholder="Optionnel" value="{{ request.form.get('description', '') }}" class="input-default">

    <label for="montant" class="label-default">Montant (USD) <span class="text-danger">*</span></label>
    <input type="number" step="0.01" min="0.01" id="montant" name="montant" required value="{{ request.form.get('montant', '') }}" class="input-default">

    <label for="date_depense" class="label-default">Date <span class="text-danger">*</span></label>
    <input type="date" id="date_depense" name="date_depense" required value="{{ request.form.get('date_depense', '') }}" class="input-default">

    <div class="form-actions">
        <a href="{{ url_for('depenses.depenses_index') }}" class="btn-link">← Retour aux dépenses</a>
        <button type="submit" class="btn-success">Enregistrer</button>
    </div>

    <div class="form-note">
        <span class="text-danger">*</span> Champs obligatoires
    </div>
</form>

<script>
function toggleFields() {
    var type = document.getElementById("type_depense").value;
    document.getElementById("standard_fields").style.display = (type === "standard") ? "block" : "none";
    toggleStandardSubFields();
}

function toggleStandardSubFields() {
    var sousType = document.getElementById("sous_type_standard").value;
    document.getElementById("autre_fields").style.display = (sousType === "autre") ? "block" : "none";
    document.getElementById("travaux_fields").style.display = (sousType === "travaux") ? "block" : "none";
    document.getElementById("examen_fields").style.display = (sousType === "examen") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", toggleFields);

// Filtrer les étudiants selon la classe choisie (travaux)
function filterEtudiants() {
    // implémenter JS côté front pour filtrer <option> des étudiants selon la classe
}

// Filtrer les cours selon la classe choisie (examens)
function filterCours() {
    // implémenter JS côté front pour filtrer <option> des cours selon la classe
}
</script>
{% endblock %}
