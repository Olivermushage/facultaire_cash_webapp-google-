{% extends "base.html" %}

{% block title %}Ajouter une autre dépense{% endblock %}

{% block content %}
<h2>Ajouter une autre dépense</h2>

{# Messages flash #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message
            {% if category == 'success' %}flash-success{% endif %}
            {% if category == 'error' %}flash-error{% endif %}
            {% if category == 'warning' %}flash-warning{% endif %}
            {% if category == 'info' %}flash-info{% endif %}">
          {{ message }}
          <button class="flash-close-btn" aria-label="Fermer le message" onclick="this.parentElement.style.display='none';">×</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" action="{{ url_for('depenses.ajouter_depense_autres') }}" class="form-default">

    <label for="type_depense" class="label-default">
        Type de dépense <span class="text-danger">*</span>
    </label>
    <select id="type_depense" name="type_depense" required class="input-default">
        <option value="" disabled selected>-- Sélectionnez un type --</option>
        <option value="manuelle">Manuelle</option>
        <option value="standard">Standard</option>
    </select>

    <div id="sous_type_container" style="display: none; margin-top: 1em;">
        <label for="sous_type" class="label-default">
            Sous-type (si Standard) <span class="text-danger">*</span>
        </label>
        <select id="sous_type" name="sous_type" class="input-default">
            <option value="" disabled selected>-- Sélectionnez un sous-type --</option>
            <option value="examen">Examen</option>
            <option value="travail">Travail</option>
            <option value="autre">Autre</option>
        </select>
    </div>

    <div id="classe_container" style="display: none; margin-top: 1em;">
        <label for="classe" class="label-default">Classe <span class="text-danger">*</span></label>
        <select id="classe" name="classe" class="input-default">
            <option value="" disabled selected>-- Sélectionnez une classe --</option>
            {% for cl in classes %}
                <option value="{{ cl }}">{{ cl }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="cours_container" style="display: none; margin-top: 1em;">
        <label for="cours" class="label-default">Cours <span class="text-danger">*</span></label>
        <select id="cours" name="cours" class="input-default">
            <option value="" disabled selected>-- Sélectionnez un cours --</option>
        </select>
    </div>

    <label for="description" class="label-default" style="margin-top: 1em;">
        Description <span class="text-danger">*</span>
    </label>
    <input type="text" id="description" name="description" required
           placeholder="Ex : Fourniture, transport..."
           value="{{ request.form.get('description', '') }}" class="input-default">

    <label for="commentaire" class="label-default" style="margin-top: 1em;">
        Commentaire (optionnel)
    </label>
    <input type="text" id="commentaire" name="commentaire"
           placeholder="Ex : précisions supplémentaires"
           value="{{ request.form.get('commentaire', '') }}" class="input-default">

    <label for="montant" class="label-default" style="margin-top: 1em;">
        Montant (USD) <span class="text-danger">*</span>
    </label>
    <input type="number" step="0.01" min="0.01" id="montant" name="montant" required
           placeholder="Ex : 150.00" value="{{ request.form.get('montant', '') }}" class="input-default">

    <label for="date_depense" class="label-default" style="margin-top: 1em;">
        Date de la dépense <span class="text-danger">*</span>
    </label>
    <input type="date" id="date_depense" name="date_depense" required
           value="{{ request.form.get('date_depense', '') }}" class="input-default">

    <div class="form-actions" style="margin-top: 1.5em;">
        <a href="{{ url_for('depenses.depenses_index') }}" class="btn-link">← Retour aux dépenses</a>
        <button type="submit" class="btn-success">Enregistrer</button>
    </div>

    <div class="form-note" style="margin-top: 1em;">
        <span class="text-danger">*</span> Champs obligatoires
    </div>
</form>

<script>
(function () {
    const typeSelect = document.getElementById("type_depense");
    const sousTypeContainer = document.getElementById("sous_type_container");
    const sousTypeSelect = document.getElementById("sous_type");
    const classeContainer = document.getElementById("classe_container");
    const classeSelect = document.getElementById("classe");
    const coursContainer = document.getElementById("cours_container");
    const coursSelect = document.getElementById("cours");
    const apiUrl = "{{ url_for('depenses.api_cours_by_classe') }}";

    function resetCours(placeholder) {
        coursSelect.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.textContent = placeholder;
        coursSelect.appendChild(opt);
    }

    typeSelect.addEventListener("change", function () {
        if (this.value === "standard") {
            sousTypeContainer.style.display = "block";
        } else {
            sousTypeContainer.style.display = "none";
            classeContainer.style.display = "none";
            coursContainer.style.display = "none";
        }
    });

    sousTypeSelect.addEventListener("change", function () {
        if (this.value === "examen") {
            classeContainer.style.display = "block";
            coursContainer.style.display = "block";
        } else if (this.value === "travail") {
            classeContainer.style.display = "block";
            coursContainer.style.display = "none";
        } else {
            classeContainer.style.display = "none";
            coursContainer.style.display = "none";
        }
    });

    classeSelect.addEventListener("change", function () {
        if (sousTypeSelect.value === "examen") {
            const classe = this.value.trim();
            if (!classe) {
                resetCours("-- Sélectionnez d'abord une classe --");
                return;
            }
            resetCours("Chargement...");
            fetch(`${apiUrl}?classe=${encodeURIComponent(classe)}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(r => r.json())
            .then(data => {
                coursSelect.innerHTML = "";
                if (data.status === "success") {
                    const liste = Array.isArray(data.cours) ? data.cours : [];
                    if (liste.length === 0) {
                        resetCours("Aucun cours trouvé");
                        return;
                    }
                    const ph = document.createElement("option");
                    ph.value = "";
                    ph.disabled = true;
                    ph.selected = true;
                    ph.textContent = "-- Sélectionnez un cours --";
                    coursSelect.appendChild(ph);

                    liste.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c;
                        opt.textContent = c;
                        coursSelect.appendChild(opt);
                    });
                } else {
                    resetCours("Erreur de chargement");
                }
            })
            .catch(err => {
                console.error(err);
                resetCours("Erreur serveur");
            });
        }
    });
})();
</script>
{% endblock %}
