{% extends "base.html" %}

{% block title %}{{ titre }}{% endblock %}

{% block content %}
<h1>{{ titre }}</h1>

<!-- Ajouter une dépense -->
<p>
  <a href="{{ url_for('depenses.ajouter_depense_examen', nom_classe=nom_classe) }}"
     class="link-default" style="font-weight:bold; text-decoration:underline;">
    ➕ Ajouter une nouvelle dépense liée à un examen
  </a>
</p>

<!-- Messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container" style="max-width:700px; margin-bottom:15px;">
      {% for category, message in messages %}
        <div class="flash-message {% if category == 'success' %}flash-success{% elif category == 'error' %}flash-error{% endif %}"
             role="alert" style="margin-bottom:10px; padding:10px; border-radius:4px; position:relative;">
          {{ message }}
          <button type="button" aria-label="Fermer le message" onclick="this.parentElement.style.display='none';"
                  style="position:absolute; top:4px; right:8px; background:transparent; border:none; font-weight:bold; cursor:pointer; color:inherit;">
            &times;
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Filtre recherche -->
<form method="get" class="form-inline mb-20" style="max-width:700px;">
    <input type="search" name="recherche" value="{{ request.args.get('recherche', '') }}"
           placeholder="Rechercher par description ou catégorie..."
           class="input-default" style="width:100%; margin-bottom:6px;">
    <button type="submit" class="btn-primary">Filtrer</button>
</form>

<!-- Tableau des cours et dépenses -->
<div class="table-scroll" style="max-width:900px; overflow-x:auto;">
  <table class="table-default" style="width:100%;" role="table">
    <thead>
      <tr>
        <th scope="col">Cours</th>
        <th scope="col">Dépenses associées</th>
      </tr>
    </thead>
    <tbody>
      {% for item in cours_depenses %}
      <tr>
        <td>{{ item.NomCours }}</td>
        <td>
          <ul style="margin:0; padding-left:20px;">
            {% for dep in item.Depenses %}
            <li style="margin-bottom:12px;">
              <strong>{{ dep.CategorieDepense }}</strong> : {{ "%.2f"|format(dep.Montant) }} USD<br>
              <em>{{ dep.Description if dep.Description else "—" }}</em><br>
              <small style="font-variant:small-caps;">Date examen : {{ dep.DateExamen or '-' }} | Utilisateur : {{ dep.utilisateur or '-' }}</small><br>
              <a href="{{ url_for('depenses.modifier_depense', index=dep.index) }}" class="link-default" style="font-size:0.9em;">✏️ Modifier</a>
            </li>
            {% endfor %}
          </ul>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="2" class="text-center" style="font-style:italic; color:#666;">Aucun résultat correspondant à votre recherche.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="pagination mt-20" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
  {% if page > 1 %}
    <a href="{{ url_for(request.endpoint, nom_classe=nom_classe, page=page-1, recherche=request.args.get('recherche','')) }}" class="link-default">&laquo; Précédent</a>
  {% else %}
    <span style="color:gray;">&laquo; Précédent</span>
  {% endif %}

  <span>Page {{ page }} sur {{ total_pages }}</span>

  {% if page < total_pages %}
    <a href="{{ url_for(request.endpoint, nom_classe=nom_classe, page=page+1, recherche=request.args.get('recherche','')) }}" class="link-default">Suivant &raquo;</a>
  {% else %}
    <span style="color:gray;">Suivant &raquo;</span>
  {% endif %}
</div>

<!-- Retour aux dépenses -->
<p class="mt-20">
  <a href="{{ url_for('depenses.depenses_index') }}" class="link-default">← Retour aux dépenses</a>
</p>
{% endblock %}
