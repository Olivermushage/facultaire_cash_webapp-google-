{% extends "base.html" %}

{% block title %}Ajouter une dépense - Examen{% endblock %}

{% block content %}
<h2>Ajouter une dépense liée à un examen</h2>

{# Messages flash #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message
            {% if category == 'success' %}flash-success{% endif %}
            {% if category == 'error' %}flash-error{% endif %}
            {% if category == 'warning' %}flash-warning{% endif %}
            {% if category == 'info' %}flash-info{% endif %}">
          {{ message }}
          <button class="flash-close-btn" aria-label="Fermer le message"
                  onclick="this.parentElement.style.display='none';">×</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" action="{{ url_for('depenses.ajouter_depense_examen') }}" class="form-default">

  <!-- Choix de la classe -->
  <label for="classe" class="label-default">
    Classe <span class="text-danger">*</span>
  </label>
  <select id="classe" name="classe" required class="input-default">
    <option value="" disabled {% if not request.form.get('classe') %}selected{% endif %}>
      -- Sélectionnez une classe --
    </option>
    {% for c in classes %}
      <option value="{{ c }}" {% if c == request.form.get('classe') %}selected{% endif %}>
        {{ c }}
      </option>
    {% endfor %}
  </select>

  <!-- Choix du cours (rempli dynamiquement) -->
  <label for="cours" class="label-default">
    Cours <span class="text-danger">*</span>
  </label>
  <select id="cours" name="cours" required class="input-default">
    <option value="" disabled selected>-- Sélectionnez d'abord une classe --</option>
  </select>

  <!-- Description obligatoire -->
  <label for="description" class="label-default">
    Description <span class="text-danger">*</span>
  </label>
  <input type="text" id="description" name="description"
         value="{{ request.form.get('description', '') }}"
         placeholder="Ex : Impression des copies" required class="input-default">

  <!-- Commentaire optionnel -->
  <label for="commentaire" class="label-default">Commentaire (optionnel)</label>
  <textarea id="commentaire" name="commentaire"
            placeholder="Détails supplémentaires (optionnel)"
            class="input-default">{{ request.form.get('commentaire', '') }}</textarea>

  <!-- Montant -->
  <label for="montant" class="label-default">
    Montant (USD) <span class="text-danger">*</span>
  </label>
  <input type="number" step="0.01" min="0.01" id="montant" name="montant"
         value="{{ request.form.get('montant', '') }}"
         placeholder="Ex : 100.00" required class="input-default">

  <!-- Date de la dépense -->
  <label for="date_depense" class="label-default">
    Date de la dépense <span class="text-danger">*</span>
  </label>
  <input type="date" id="date_depense" name="date_depense"
         value="{{ request.form.get('date_depense', '') }}" required class="input-default">

  <div class="form-actions">
    <a href="{{ url_for('depenses.depenses_index') }}" class="btn-link">← Retour aux dépenses</a>
    <button type="submit" class="btn-success">Enregistrer</button>
  </div>

  <div class="form-note">
    <span class="text-danger">*</span> Champs obligatoires
  </div>
</form>

<!-- Script AJAX pour charger les cours d'une classe -->
<script>
(function () {
  const selectClasse = document.getElementById("classe");
  const selectCours  = document.getElementById("cours");
  const apiUrl       = "{{ url_for('depenses.api_cours_by_classe') }}"; // /depenses/api/cours

  function resetCours(placeholder) {
    selectCours.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.disabled = true;
    opt.selected = true;
    opt.textContent = placeholder;
    selectCours.appendChild(opt);
  }

  selectClasse.addEventListener("change", function () {
    const classe = this.value.trim();
    if (!classe) {
      resetCours("-- Sélectionnez d'abord une classe --");
      return;
    }
    resetCours("Chargement...");

    fetch(`${apiUrl}?classe=${encodeURIComponent(classe)}`, {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(r => r.json())
      .then(data => {
        selectCours.innerHTML = "";
        if (data.status === "success") {
          const liste = Array.isArray(data.cours) ? data.cours : [];
          if (liste.length === 0) {
            resetCours("Aucun cours trouvé");
            return;
          }
          const ph = document.createElement("option");
          ph.value = "";
          ph.disabled = true;
          ph.selected = true;
          ph.textContent = "-- Sélectionnez un cours --";
          selectCours.appendChild(ph);

          liste.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            selectCours.appendChild(opt);
          });
        } else {
          resetCours("Erreur de chargement");
        }
      })
      .catch(err => {
        console.error(err);
        resetCours("Erreur serveur");
      });
  });
})();
</script>
{% endblock %}
