{% extends "base.html" %}

{% block title %}Ajouter dépense liée à un examen pour {{ nom_classe }}{% endblock %}

{% block content %}
<h2>Ajouter une dépense liée à un examen</h2>

{# Messages flash #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message
            {% if category == 'success' %}flash-success{% endif %}
            {% if category == 'error' %}flash-error{% endif %}
            {% if category == 'warning' %}flash-warning{% endif %}
            {% if category == 'info' %}flash-info{% endif %}">
          {{ message }}
          <button class="flash-close-btn" aria-label="Fermer le message" onclick="this.parentElement.style.display='none';">×</button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" action="{{ url_for('depenses.ajouter_depense_examen', nom_classe=nom_classe) }}" class="form-default">

    <label for="nom_cours" class="label-default">
        Cours concerné <span class="text-danger">*</span>
    </label>
    <select id="nom_cours" name="nom_cours" required class="input-default">
        <option value="" disabled {% if not nom_cours_selectionne %}selected{% endif %}>-- Choisissez un cours --</option>
        {% for cours in cours_classe %}
            <option value="{{ cours }}" {% if cours == nom_cours_selectionne %}selected{% endif %}>{{ cours }}</option>
        {% endfor %}
    </select>
    <small class="text-muted">Sélectionnez le cours lié à la dépense.</small>

    <label for="date_examen" class="label-default">
        Date de l'examen <span class="text-danger">*</span>
    </label>
    <input type="date" id="date_examen" name="date_examen" required
           value="{{ date_examen_valeur or '' }}" class="input-default">
    <small class="text-muted">Date concernée par cette dépense.</small>

    <label for="categorie" class="label-default">
        Catégorie de dépense <span class="text-danger">*</span>
    </label>
    <select id="categorie" name="categorie" required class="input-default">
        <option value="" disabled {% if not categorie_selectionnee %}selected{% endif %}>-- Choisissez une catégorie --</option>
        {% for cat in categories %}
            <option value="{{ cat }}" {% if cat == categorie_selectionnee %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
    </select>
    <small class="text-muted">Choisissez la catégorie liée à la dépense.</small>

    <div id="div_categorie_autre" style="{% if categorie_selectionnee != 'Autre' %}display: none;{% endif %}">
        <label for="categorie_autre" class="label-default">
            Précisez la catégorie <span class="text-danger">*</span>
        </label>
        <input type="text" id="categorie_autre" name="categorie_autre"
               placeholder="Précisez la catégorie"
               value="{{ categorie_autre_valeur or '' }}"
               class="input-default">
    </div>

    <label for="description" class="label-default">Description</label>
    <input type="text" id="description" name="description" placeholder="Optionnel"
           value="{{ description_valeur or '' }}" class="input-default">

    <label for="montant" class="label-default">
        Montant (USD) <span class="text-danger">*</span>
    </label>
    <input type="number" step="0.01" min="0.01" id="montant" name="montant" required
           placeholder="Ex : 100.00" value="{{ montant_valeur or '' }}" class="input-default">
    <small class="text-muted">Montant total dépensé.</small>

    <div class="form-actions">
        <a href="{{ url_for('depenses.depenses_index') }}" class="btn-link">← Retour aux dépenses</a>
        <button type="submit" class="btn-success">Enregistrer</button>
    </div>

    <div class="form-note">
        <span class="text-danger">*</span> Champs obligatoires
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectCategorie = document.getElementById('categorie');
    const divCategorieAutre = document.getElementById('div_categorie_autre');
    const inputCategorieAutre = document.getElementById('categorie_autre');

    function toggleCategorieAutre() {
        if (selectCategorie.value === 'Autre') {
            divCategorieAutre.style.display = 'block';
            inputCategorieAutre.setAttribute('required', 'required');
        } else {
            divCategorieAutre.style.display = 'none';
            inputCategorieAutre.removeAttribute('required');
            inputCategorieAutre.value = '';
        }
    }

    selectCategorie.addEventListener('change', toggleCategorieAutre);
    toggleCategorieAutre();
});
</script>
{% endblock %}
